---

title: gradless


keywords: fastai
sidebar: home_sidebar



nb_path: "index.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: index.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This is an implementation of gradient descent designed to work without access to the exact gradient. To deal with this problem, it uses James Spall's <a href="https://www.jhuapl.edu/SPSA/PDF-SPSA/Spall_An_Overview.PDF">simultaneous perturbation stochastic approximation (SPSA)</a> to replace the missing gradient.</p>
<p>SPSA is particularly useful for optimization problems where the objective function itself is noisy, such that the exact gradient cannot be evaluated. For example, if the model at hand is evaluated by simulations rather than exact computations. This is in contrast to more typical applications of stochastic gradient descent, where the gradient can be computed, but noise is introduced through subsampling of the data (e.g. minibatching) or by Monte Carlo integration (e.g. in variational inference).</p>
<h2 id="Goals">Goals<a class="anchor-link" href="#Goals"> </a></h2><p>This is a library I'm developing for use in a research problem of personal interest involving a noisy objective function. As such, it is both still in development and likely to be tailored toward my needs. My principle aim in writing this library is to have a structured, modular, and easy-to-modify framework with a defined API, separate from the actual model I'm working on so that the problem and the tools being applied to the problem are kept separate, hopefully making my research workflow cleaner and more efficient.</p>
<p>I decided to use this as an opportunity to try incorporating literate programming, as accomplished by <a href="https://github.com/fastai/nbdev"><code>nbdev</code></a>, into my development workflow. I've been relying heavily on Jupyter notebooks to document my analyses by interspersing code and narrative. Extending this programming style to script development seemed like a good idea. In brief, <code>nbdev</code> provides a set of tools for organizing a Python project as set of Jupyter notebooks. All of the actual development takes place in those Jupyter notebooks, rather than an IDE. <code>nbdev</code> then extracts all code in cells marked with the header <code>#export</code> to a set of Python scripts and generates documentation from the markdown cells and code cells not labelled <code>#export</code> or <code>#hide</code>. I am very much enjoying <code>nbdev</code> and have so far found it a painless and natural approach to writing scripts, and actually getting documentation done (I know I sound like a shill, but it really feels like a phenomenal and transformative tool). This scripts, documentation, and webpage found <a href="laptopbiologist.github.io/gradless">here</a> were all automatically generated by <code>nbdev</code> from the <code>*.ipynb</code> notebooks found in the repositories main directory.</p>
<p>As this is still in development and geared for personal use, I can't make any general guarantees about its performance or behavior. So if you must use it, use with caution and skepticism.</p>
<h2 id="To-do">To do<a class="anchor-link" href="#To-do"> </a></h2><ul>
<li>Incorporate just-in-time compilation with JAX to speed up time-consuming functions</li>
<li>Define a class to organize minibatching. Probably class that wraps datasets along with instructions for how to minibatch the data. This would be called by the <code>[`Model`](/gradless/models.html#Model)</code> class when it evaluates the cost function with data. May need to modify <code>[`Model`](/gradless/models.html#Model)</code> a bit in terms of how it stores and uses <code>self.data</code>.</li>
<li>Implement some procedures for smart hyperparameter choice</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Example-usage">Example usage<a class="anchor-link" href="#Example-usage"> </a></h2><p>Okay, let's try out a few toy examples, just to demonstrate how the API works.</p>
<p>First we'll import the packages that we need.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span>
<span class="kn">import</span> <span class="nn">seaborn</span>

<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">from</span> <span class="nn">gradless</span> <span class="kn">import</span> <span class="n">optimizers</span><span class="p">,</span> <span class="n">costs</span><span class="p">,</span> <span class="n">gradient</span><span class="p">,</span> <span class="n">updates</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Simple-linear-regression">Simple linear regression<a class="anchor-link" href="#Simple-linear-regression"> </a></h3><p>Let's say we are interested in the mean-squared error of a simple linear regression.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now let's generate 200 data points from a simple linear relationship, with a slope of 2 and an intercept of 5:</p>
<p>{% raw %}
$$x \sim normal(0, 5)$$
{% endraw %}</p>
<p>{% raw %}
$$\epsilon \sim normal(0,2)$$
{% endraw %}</p>
<p>{% raw %}
$$y=2x+5+\epsilon$$
{% endraw %}</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">x</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<span class="n">err</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<span class="n">slope</span><span class="o">=</span><span class="mi">2</span>
<span class="n">intercept</span><span class="o">=</span><span class="mi">5</span>
<span class="n">y</span><span class="o">=</span><span class="n">x</span><span class="o">*</span><span class="n">slope</span><span class="o">+</span><span class="n">intercept</span> <span class="o">+</span><span class="n">err</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Text(0.5, 0, &#39;x&#39;)</pre>
</div>

</div>

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,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
"
>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's organized this data as a dictionary</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span><span class="n">x</span><span class="p">,</span>
     <span class="s1">&#39;y&#39;</span><span class="p">:</span><span class="n">y</span><span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we need a function that takes a vector of parameter values and data and uses these to returns a float. Note that it does not matter how the data is organized, so long as the function can interpret it internally.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">MSE</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
    <span class="n">y_pred</span><span class="o">=</span><span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="o">+</span><span class="n">theta</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">y_pred</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Okay, now we'll wrap the cost function and the data in the <code>[`Model`](/gradless/models.html#Model)</code> class</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mse_cost</span><span class="o">=</span><span class="n">costs</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="n">MSE</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We'll fit this using the standard gradient descent algorithm described <a href="https://www.jhuapl.edu/SPSA/PDF-SPSA/Spall_An_Overview.PDF">hera</a>. To do this, we're going to construct an instance of the <code>[`GradientDescent`](/gradless/optimizers.html#GradientDescent)</code> class, passing it the model, an initial guess, and an update rule.</p>
<p>First, we'll choose an update rule from the <code>updates</code> submodule, creating an instance of the <code>[`StandardSPSA`](/gradless/updates.html#StandardSPSA)</code> class.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">update_rule</span><span class="o">=</span><span class="n">updates</span><span class="o">.</span><span class="n">StandardSPSA</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we'll create an instance of the <code>[`GradientDescent`](/gradless/optimizers.html#GradientDescent)</code> optimizer.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">starts</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">9</span><span class="p">,</span><span class="o">-</span><span class="mi">9</span><span class="p">])</span> <span class="c1">#Here&#39;s our initial guess</span>
<span class="n">opt_vanilla</span><span class="o">=</span><span class="n">optimizers</span><span class="o">.</span><span class="n">GradientDescent</span><span class="p">(</span><span class="n">x_0</span> <span class="o">=</span> <span class="n">starts</span><span class="p">,</span>
                                       <span class="n">cost</span> <span class="o">=</span> <span class="n">mse_cost</span><span class="p">,</span>
                                       <span class="n">update</span> <span class="o">=</span> <span class="n">update_rule</span><span class="p">,</span>
                                       <span class="n">gradient</span><span class="o">=</span><span class="n">gradient</span><span class="o">.</span><span class="n">SPSAGradient</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])),</span>
                                       <span class="n">param_stepsize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">param_stepdecay</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">param_decay_offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                                       <span class="n">grad_stepsize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grad_stepdecay</span><span class="o">=.</span><span class="mi">3</span><span class="p">,</span> <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Note that there are additional parameters that need to be defined. The arguments beginning with <code>param</code> all control the much the parameters will be updated at each iteration and how this decays over time. The two arguments beginning with <code>grad</code> control how much the model parameters will be perturbed during the gradient approximation. It may be necessary to tune these parameters to work with a given model.</p>
<p>Now we can optimize the model by iteratively calling the <code>update_params</code> method of the <code>[`GradientDescent`](/gradless/optimizers.html#GradientDescent)</code> instance. Note that we can use the <code>tqdm</code> library to create a progress bar for the fit</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">opt_vanilla</span><span class="o">.</span><span class="n">update_params</span><span class="p">(</span><span class="n">gradient_reps</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_step</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">)):</span>
    <span class="n">opt_vanilla</span><span class="o">.</span><span class="n">update_params</span><span class="p">(</span><span class="n">gradient_reps</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">max_step</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="c1">#     elbo.sample_rvs()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">ValueError</span>                                Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-9-ddb2d21a4ae9&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-fg">----&gt; 1</span><span class="ansi-red-fg"> </span>opt_vanilla<span class="ansi-blue-fg">.</span>update_params<span class="ansi-blue-fg">(</span>gradient_reps<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">100</span><span class="ansi-blue-fg">,</span> max_step<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">      2</span> <span class="ansi-green-fg">for</span> i <span class="ansi-green-fg">in</span> tqdm<span class="ansi-blue-fg">(</span>range<span class="ansi-blue-fg">(</span><span class="ansi-cyan-fg">10000</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">      3</span>     opt_vanilla<span class="ansi-blue-fg">.</span>update_params<span class="ansi-blue-fg">(</span>gradient_reps<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">3</span><span class="ansi-blue-fg">,</span> max_step<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">      4</span> <span class="ansi-red-fg">#     elbo.sample_rvs()</span>

<span class="ansi-green-fg">~/projects/gradless/gradless/optimizers.py</span> in <span class="ansi-cyan-fg">update_params</span><span class="ansi-blue-fg">(self, gradient_reps, block_val, update_rvs, max_step)</span>
<span class="ansi-green-intense-fg ansi-bold">     54</span> 
<span class="ansi-green-intense-fg ansi-bold">     55</span>         <span class="ansi-red-fg">### update the parameters</span>
<span class="ansi-green-fg">---&gt; 56</span><span class="ansi-red-fg">         </span>new_theta<span class="ansi-blue-fg">=</span>self<span class="ansi-blue-fg">.</span>theta<span class="ansi-blue-fg">-</span>step
<span class="ansi-green-intense-fg ansi-bold">     57</span>         new_cost<span class="ansi-blue-fg">=</span>self<span class="ansi-blue-fg">.</span>cost<span class="ansi-blue-fg">.</span>evaluate<span class="ansi-blue-fg">(</span>new_theta<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     58</span> 

<span class="ansi-red-fg">ValueError</span>: operands could not be broadcast together with shapes (2,) (100,) </pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The <code>max_step</code> argument in <code>update_params</code> can be used to limit how much parameters are allowed to be updated in each iteration, which can served as heuristic to limit divergences, especially in the early iterations where the learning rate is high.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We could also have employed other gradient descent update rules, for example Nestorov-accelerated Adam, which uses the history of prior gradients to (hopefully) more informed updates.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">update_rule</span><span class="o">=</span><span class="n">updates</span><span class="o">.</span><span class="n">NADAM</span><span class="p">(</span> <span class="n">beta1</span><span class="o">=.</span><span class="mi">9</span><span class="p">)</span>
<span class="n">opt_NADAM</span><span class="o">=</span><span class="n">optimizers</span><span class="o">.</span><span class="n">GradientDescent</span><span class="p">(</span><span class="n">starts</span><span class="p">,</span><span class="n">mse_cost</span><span class="p">,</span><span class="n">update_rule</span><span class="p">,</span><span class="n">gradient</span><span class="o">.</span><span class="n">SPSAGradient</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])),</span><span class="n">param_stepsize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">param_stepdecay</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">param_decay_offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                 <span class="n">grad_stepsize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grad_stepdecay</span><span class="o">=.</span><span class="mi">2</span><span class="p">,</span> <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">opt_NADAM</span><span class="o">.</span><span class="n">update_params</span><span class="p">(</span><span class="n">gradient_reps</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_step</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">)):</span>
    <span class="n">opt_NADAM</span><span class="o">.</span><span class="n">update_params</span><span class="p">(</span><span class="n">gradient_reps</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">max_step</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="c1">#     elbo.sample_rvs()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="o">=</span><span class="p">[],[],[]</span>
<span class="k">for</span> <span class="n">slope</span> <span class="ow">in</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span><span class="o">.</span><span class="mi">2</span><span class="p">):</span>

    <span class="k">for</span> <span class="n">intercept</span> <span class="ow">in</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span><span class="o">.</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">Y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intercept</span><span class="p">)</span>
        <span class="n">X</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slope</span><span class="p">)</span>
        <span class="n">Z</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mse_cost</span><span class="o">.</span><span class="n">evaluate</span><span class="p">([</span><span class="n">slope</span><span class="p">,</span><span class="n">intercept</span><span class="p">]))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pyplot</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
<span class="n">theta_hist</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">opt_vanilla</span><span class="o">.</span><span class="n">theta_hist</span><span class="p">)</span>
<span class="n">sc</span><span class="o">=</span><span class="n">pyplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Z</span><span class="p">),</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">starts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">starts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">theta_hist</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">theta_hist</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">theta_hist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">theta_hist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>

<span class="n">cbar</span><span class="o">=</span><span class="n">pyplot</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;log (MSE)&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Intercept&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Slope&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Standard SPSA gradient descent&#39;</span><span class="p">)</span>

<span class="n">pyplot</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
<span class="n">theta_hist</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">opt_NADAM</span><span class="o">.</span><span class="n">theta_hist</span><span class="p">)</span>
<span class="n">sc</span><span class="o">=</span><span class="n">pyplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Z</span><span class="p">),</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">starts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">starts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">theta_hist</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">theta_hist</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">theta_hist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">theta_hist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>

<span class="n">cbar</span><span class="o">=</span><span class="n">pyplot</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;log (MSE)&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Intercept&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Slope&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Nesterov-accelerated Adam with SPSA&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pyplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">opt_vanilla</span><span class="o">.</span><span class="n">cost_history</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;StandardSPSA&#39;</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">opt_NADAM</span><span class="o">.</span><span class="n">cost_history</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;NADAM&#39;</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;MSE&#39;</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Iteration&#39;</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Fitting-the-same-regression-with-an-intentionally-bad-loss-function">Fitting the same regression with an intentionally bad loss function<a class="anchor-link" href="#Fitting-the-same-regression-with-an-intentionally-bad-loss-function"> </a></h3><p>Let's say instead that we decided to optimize this is in a pretty nonsensical fashion. Instead of just computing the loss as</p>
<p>{% raw %}
$$\sum_i (y_i - \hat{y}_i)^2$$
{% endraw %}</p>
<p>we'll add a considerable amount of noise to each prediction and compute it as</p>
<p>{% raw %}
$$\epsilon_1,...,\epsilon_n \sim Normal(\mu=0,\sigma =30)$$
{% endraw %}
{% raw %}
$$\sum_i (y_i - (\hat{y}_i + \epsilon_i) )^2$$
{% endraw %}</p>
<p>This is essentially simulating a noisier dataset from the proposed parameters and the computing the distance between the y-values in the real and simulated data.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">MSE_simulated_data</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
    <span class="n">y_pred</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span> <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="o">+</span><span class="n">theta</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">30.</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">y_pred</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Then we instatiate an instance of the <code>[`GradientDescent`](/gradless/optimizers.html#GradientDescent)</code> class with the model, the initial guess, and the update rule.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mse_sim_cost</span><span class="o">=</span><span class="n">costs</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">MSE_simulated_data</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">starts</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">9</span><span class="p">,</span><span class="o">-</span><span class="mi">9</span><span class="p">])</span>
<span class="n">update_rule</span><span class="o">=</span><span class="n">updates</span><span class="o">.</span><span class="n">StandardSPSA</span><span class="p">()</span>
<span class="n">opt_vanilla</span><span class="o">=</span><span class="n">optimizers</span><span class="o">.</span><span class="n">GradientDescent</span><span class="p">(</span><span class="n">starts</span><span class="p">,</span><span class="n">mse_sim_cost</span><span class="p">,</span><span class="n">update_rule</span><span class="p">,</span>
                                       <span class="n">gradient</span><span class="o">.</span><span class="n">SPSAGradient</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])),</span>
                                       <span class="n">param_stepsize</span><span class="o">=.</span><span class="mi">2</span><span class="p">,</span> <span class="n">param_stepdecay</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">param_decay_offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                                       <span class="n">grad_stepsize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grad_stepdecay</span><span class="o">=.</span><span class="mi">2</span><span class="p">,</span> <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">opt_vanilla</span><span class="o">.</span><span class="n">update_params</span><span class="p">(</span><span class="n">gradient_reps</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_step</span><span class="o">=.</span><span class="mi">1</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">50000</span><span class="p">)):</span>
    <span class="n">opt_vanilla</span><span class="o">.</span><span class="n">update_params</span><span class="p">(</span><span class="n">gradient_reps</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">max_step</span><span class="o">=.</span><span class="mi">1</span><span class="p">)</span>
<span class="c1">#     elbo.sample_rvs()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The <code>max_step</code> argument in <code>update_params</code> can be used to limit how much parameters are allowed to be updated in each iteration, which can served as heuristic to limit divergences, especially in the early iterations where the learning rate is high.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mse_sim_cost</span><span class="o">=</span><span class="n">costs</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">MSE_simulated_data</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">starts</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">9</span><span class="p">,</span><span class="o">-</span><span class="mi">9</span><span class="p">])</span>
<span class="n">update_rule</span><span class="o">=</span><span class="n">updates</span><span class="o">.</span><span class="n">NADAM</span><span class="p">(</span> <span class="n">beta1</span><span class="o">=.</span><span class="mi">9</span><span class="p">)</span>
<span class="n">opt_NADAM</span><span class="o">=</span><span class="n">optimizers</span><span class="o">.</span><span class="n">GradientDescent</span><span class="p">(</span><span class="n">starts</span><span class="p">,</span><span class="n">mse_sim_cost</span><span class="p">,</span><span class="n">update_rule</span><span class="p">,</span><span class="n">gradient</span><span class="o">.</span><span class="n">SPSAGradient</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])),</span><span class="n">param_stepsize</span><span class="o">=.</span><span class="mi">2</span><span class="p">,</span> <span class="n">param_stepdecay</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">param_decay_offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                 <span class="n">grad_stepsize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grad_stepdecay</span><span class="o">=.</span><span class="mi">2</span><span class="p">,</span> <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">opt_NADAM</span><span class="o">.</span><span class="n">update_params</span><span class="p">(</span><span class="n">gradient_reps</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_step</span><span class="o">=.</span><span class="mi">1</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">50000</span><span class="p">)):</span>
    <span class="n">opt_NADAM</span><span class="o">.</span><span class="n">update_params</span><span class="p">(</span><span class="n">gradient_reps</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">max_step</span><span class="o">=.</span><span class="mi">1</span><span class="p">)</span>
<span class="c1">#     elbo.sample_rvs()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="o">=</span><span class="p">[],[],[]</span>
<span class="k">for</span> <span class="n">slope</span> <span class="ow">in</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span><span class="o">.</span><span class="mi">2</span><span class="p">):</span>

    <span class="k">for</span> <span class="n">intercept</span> <span class="ow">in</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span><span class="o">.</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">Y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intercept</span><span class="p">)</span>
        <span class="n">X</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slope</span><span class="p">)</span>
        <span class="n">Z</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mse_sim_cost</span><span class="o">.</span><span class="n">evaluate</span><span class="p">([</span><span class="n">slope</span><span class="p">,</span><span class="n">intercept</span><span class="p">]))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pyplot</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
<span class="n">theta_hist</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">opt_vanilla</span><span class="o">.</span><span class="n">theta_hist</span><span class="p">)</span>
<span class="n">sc</span><span class="o">=</span><span class="n">pyplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Z</span><span class="p">),</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">starts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">starts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">theta_hist</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">theta_hist</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">theta_hist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">theta_hist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>

<span class="n">cbar</span><span class="o">=</span><span class="n">pyplot</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;log (MSE)&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Intercept&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Slope&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Standard SPSA gradient descent&#39;</span><span class="p">)</span>

<span class="n">pyplot</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
<span class="n">theta_hist</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">opt_NADAM</span><span class="o">.</span><span class="n">theta_hist</span><span class="p">)</span>
<span class="n">sc</span><span class="o">=</span><span class="n">pyplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Z</span><span class="p">),</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">starts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">starts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">theta_hist</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">theta_hist</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">theta_hist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">theta_hist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>

<span class="n">cbar</span><span class="o">=</span><span class="n">pyplot</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;log (MSE)&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Intercept&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Slope&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Nesterov-accelerated Adam with SPSA&#39;</span><span class="p">)</span>
<span class="c1"># pyplot.figure(figsize=(8,8))</span>
<span class="c1"># sc=pyplot.scatter(X,Y, c=numpy.log(Z), zorder=-1, s=20)</span>
<span class="c1"># pyplot.scatter(starts[0], starts[1], c=&#39;white&#39;, edgecolor=&#39;black&#39;, s=100)</span>
<span class="c1"># pyplot.plot(theta_hist[:,0],theta_hist[:,1], c=&#39;red&#39;, lw=2, zorder=0)</span>
<span class="c1"># pyplot.scatter(theta_hist[-1,0],theta_hist[-1,1], c=&#39;red&#39;, lw=2, zorder=0)</span>
<span class="c1"># pyplot.scatter(2, 5, marker=&#39;x&#39;, c=&#39;white&#39;, s=200)</span>

<span class="c1"># cbar=pyplot.colorbar(sc)</span>
<span class="c1"># cbar.set_label(&#39;log (MSE)&#39;, size=14)</span>
<span class="c1"># pyplot.ylabel(&#39;Intercept&#39;, size=14)</span>
<span class="c1"># pyplot.xlabel(&#39;Slope&#39;, size=14)</span>
<span class="c1"># pyplot.xlim(-15,15)</span>
<span class="c1"># pyplot.ylim(-15,15)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>It's likely that choosing different parameters for the step size of the standard SPSA gradient descent would lead to better performance.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="High-dimensional-model">High dimensional model<a class="anchor-link" href="#High-dimensional-model"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ndim</span><span class="o">=</span><span class="mi">100</span>
<span class="n">means</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">ndim</span><span class="p">)</span>
<span class="n">sd</span><span class="o">=</span><span class="mf">2.</span><span class="o">**</span><span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mf">1.5</span> <span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">ndim</span><span class="p">)</span>
<span class="n">data</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">means</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">ndim</span><span class="p">))</span>
<span class="n">true_param</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">ndim</span><span class="p">)</span>
<span class="n">true_param</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">means</span>
<span class="n">true_param</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">sd</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">starts</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">means</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">sd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">evidence</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="c1">#priors</span>
    <span class="n">mu</span><span class="o">=</span><span class="n">theta</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">sd</span><span class="o">=</span><span class="n">theta</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">mu_prior</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">logpdf</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">sd_prior</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">logpdf</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    
    <span class="n">loglk</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">logpdf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span><span class="mf">2.</span><span class="o">**</span><span class="p">(</span><span class="n">sd</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">mu_prior</span><span class="o">+</span><span class="n">sd_prior</span><span class="o">+</span><span class="n">loglk</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To make this noisy, before evaluating the parameters, I'm going to add some noise drawn from $Normal(0,.5)$ to them.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">noisy_evidence</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="c1">#priors</span>
    <span class="n">mu</span><span class="o">=</span><span class="n">theta</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">sd</span><span class="o">=</span><span class="n">theta</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
    
    <span class="n">mu_noise</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">mu</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">sd_noise</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sd</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    
    <span class="n">mu_prior</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">logpdf</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">sd_prior</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">logpdf</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    
    <span class="n">loglk</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">logpdf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mu</span><span class="o">+</span><span class="n">mu_noise</span><span class="p">,</span><span class="mf">2.</span><span class="o">**</span><span class="p">(</span><span class="n">sd</span><span class="o">+</span><span class="n">sd_noise</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">mu_prior</span><span class="o">+</span><span class="n">sd_prior</span><span class="o">+</span><span class="n">loglk</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span> <span class="p">(</span><span class="n">evidence</span><span class="p">(</span><span class="n">starts</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">seaborn</span><span class="o">.</span><span class="n">distplot</span><span class="p">([</span><span class="n">noisy_evidence</span><span class="p">(</span><span class="n">true_param</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">200</span><span class="p">)])</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">evidence</span><span class="p">(</span><span class="n">true_param</span><span class="p">,</span> <span class="n">data</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span> <span class="p">(</span><span class="n">starts</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span><span class="o">=</span><span class="n">costs</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">noisy_evidence</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

<span class="n">update_rule</span><span class="o">=</span><span class="n">updates</span><span class="o">.</span><span class="n">NADAM</span><span class="p">(</span> <span class="n">beta1</span><span class="o">=.</span><span class="mi">9</span><span class="p">)</span>
<span class="n">opt</span><span class="o">=</span><span class="n">optimizers</span><span class="o">.</span><span class="n">GradientDescent</span><span class="p">(</span><span class="n">starts</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">update_rule</span><span class="p">,</span><span class="n">gradient</span><span class="o">.</span><span class="n">SPSAGradient</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">ndim</span><span class="p">),</span>
                               <span class="n">param_stepsize</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">param_stepdecay</span> <span class="o">=</span> <span class="o">.</span><span class="mi">2</span><span class="p">,</span> <span class="n">param_decay_offset</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> 
                               <span class="n">grad_stepsize</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">grad_stepdecay</span> <span class="o">=</span> <span class="o">.</span><span class="mi">2</span><span class="p">,</span> <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">opt</span><span class="o">.</span><span class="n">update_params</span><span class="p">(</span><span class="n">gradient_reps</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_step</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">)):</span>
    <span class="n">opt</span><span class="o">.</span><span class="n">update_params</span><span class="p">(</span><span class="n">gradient_reps</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">block_val</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">max_step</span><span class="o">=</span><span class="mi">1</span> <span class="p">)</span>
<span class="c1">#     elbo.sample_rvs()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">20000</span><span class="p">)):</span>
    <span class="n">opt</span><span class="o">.</span><span class="n">update_params</span><span class="p">(</span><span class="n">gradient_reps</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">block_val</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">max_step</span><span class="o">=</span><span class="mi">1</span> <span class="p">)</span>
<span class="c1">#     elbo.sample_rvs()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">theta_hist</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pyplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">cost_history</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">theta_hist</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">theta_hist</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">true_param</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pyplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">theta_hist</span><span class="p">[</span><span class="o">-</span><span class="mi">10000</span><span class="p">:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">theta_hist</span><span class="p">[</span><span class="o">-</span><span class="mi">10000</span><span class="p">:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">true_param</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">true_param</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">theta_hist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span><span class="o">-</span> <span class="n">theta_hist</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,:]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pyplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">theta_hist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,::</span><span class="mi">2</span><span class="p">],</span> <span class="n">means</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">numpy</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">theta_hist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,::</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">means</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pyplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">theta_hist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">sd</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's compare this to the posterior means, inferred using PyMC3. I'll set up the model and draw samples from the posterior using the No-U-Turn Sampler (NUTS).</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pymc3</span> <span class="k">as</span> <span class="nn">pm</span>
<span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model</span><span class="p">:</span>
    <span class="n">mu</span><span class="o">=</span><span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;mu&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">ndim</span><span class="p">)</span>
    <span class="n">std</span><span class="o">=</span><span class="mf">2.</span><span class="o">**</span><span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;sd&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">ndim</span><span class="p">)</span>
    <span class="n">obs</span><span class="o">=</span><span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;obs&#39;</span><span class="p">,</span><span class="n">mu</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="k">with</span> <span class="n">model</span><span class="p">:</span>
    <span class="n">trace</span><span class="o">=</span><span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's compute the posterior means</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mean_mu</span><span class="o">=</span><span class="n">trace</span><span class="p">[</span><span class="s1">&#39;mu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">sd_mu</span><span class="o">=</span><span class="n">trace</span><span class="p">[</span><span class="s1">&#39;sd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">And</span> <span class="n">now</span> <span class="n">well</span> <span class="n">plot</span> <span class="n">the</span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pyplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">theta_hist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,::</span><span class="mi">2</span><span class="p">],</span> <span class="p">(</span><span class="n">mean_mu</span><span class="p">))</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="o">-</span><span class="mi">30</span><span class="p">,</span><span class="mi">20</span><span class="p">],[</span><span class="o">-</span><span class="mi">30</span><span class="p">,</span><span class="mi">20</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pyplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">theta_hist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">],</span> <span class="p">(</span><span class="n">sd_mu</span><span class="p">))</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">],[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pyplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">cost_history</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

